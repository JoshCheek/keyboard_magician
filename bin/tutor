#!/usr/bin/env ruby

# THIS IS ALL UNTESTED
$LOAD_PATH.unshift File.expand_path '../../lib', __FILE__

require 'keyboard_magician/console'
require 'time'

system "stty raw" if $stdin.tty?

begin
  target_string = 'abc def'
  start_time    = Time.now
  user_input    = KeyboardMagician::UserInput.new []
  characters    = []
  game_stats    = nil

  loop do
    # eventually, this should turn into something smarter
    # probably moving the current char along, which will fix the cursor
    # and turn each input into a 1 or 2 character change instead of having
    # to rewrite the string each time
    print Output.new(target_string, user_input.to_s).map { |c, meaning|
      if meaning == :correct
        "\e[30;42m#{c}"
      elsif meaning == :incorrect
        "\e[37;41m#{c}"
      else
        "\e[0m#{c}"
      end
    }.join("")
    print "\r"
    game_stats = GameStats.new target_string: target_string,
                               input_string:  user_input.to_s,
                               seconds_taken: (Time.now-start_time).to_i
    break if game_stats.over?
    raw_char   = KeyboardMagician::Console::ParseCharacter.call($stdin.getc)
    characters << KeyboardMagician::Character.new(*raw_char)
    user_input = KeyboardMagician::UserInput.new characters
  end
ensure
  system "stty -raw" if $stdin.tty?
end

puts "\e[0m"
puts "Game Stats"
puts "=========="
puts "time taken:            #{game_stats.seconds_taken.inspect}"
puts "characters per second: #{game_stats.cps}"
puts "num errors:            #{game_stats.num_errors}"
